""" 
Orquestador Multi-Agente para Ingenier√≠a de Datos - Versi√≥n Enterprise
Autor: Jonatan Polanco
Fecha: Septiembre 2025
"""

import os
import typer
from rich.console import Console
from rich.panel import Panel
from dotenv import load_dotenv
import logging
import sys
from datetime import datetime
import uuid

# Importaciones modulares
from src.core.team_builder import build_team, generate_session_id
from src.storage.db_utils import list_user_sessions, clear_session_history

# Configuraci√≥n
load_dotenv()
console = Console()

# Configurar logging
logging.basicConfig(
    level=logging.ERROR,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    stream=sys.stdout
)
logger = logging.getLogger(__name__)

# CLI
app = typer.Typer(help="CLI para equipo de agentes de IA para Ingenier√≠a de Datos.")

def print_welcome_banner(session_id: str, user: str, is_new_session: bool = True):
    """Muestra un banner de bienvenida con informaci√≥n de la sesi√≥n."""
    session_type = "Nueva sesi√≥n" if is_new_session else "Sesi√≥n existente"
    
    console.print(Panel(
        f"[bold green]üöÄ Equipo Multi-Agente de Ingenier√≠a de Datos[/bold green]\n\n"
        f"üë§ [bold]Usuario:[/bold] [cyan]{user}[/cyan]\n"
        f"üìã [bold]Session ID:[/bold] [yellow]{session_id}[/yellow]\n"
        f"üîÑ [bold]Tipo:[/bold] [green]{session_type}[/green]\n\n"
        f"üéØ [bold]Agentes disponibles:[/bold]\n"
        f"  ‚Ä¢ ü§ñ RAG Agent (Conocimiento interno)\n"
        f"  ‚Ä¢ üåê Web Agent (B√∫squeda en documentaci√≥n)\n"
        f"  ‚Ä¢ üíª Code Standards Agent (Generaci√≥n de c√≥digo)\n\n"
        f"üí° [bold]Comandos especiales:[/bold]\n"
        f"  ‚Ä¢ [cyan]exit[/cyan] - Salir del chat\n"
        f"  ‚Ä¢ [cyan]clear[/cyan] - Limpiar contexto de esta sesi√≥n\n"
        f"  ‚Ä¢ [cyan]new[/cyan] - Crear nueva sesi√≥n\n",
        title="Sistema de Soporte Senior para Ingenier√≠a de Datos",
        border_style="blue",
        padding=(1, 2)
    ))

@app.command()
def chat(
    user: str = typer.Option("default_user", help="ID de usuario"),
    session: str = typer.Option(None, help="Session ID espec√≠fica (opcional)"),
    clear_history: bool = typer.Option(False, help="Limpiar historial de sesi√≥n existente")
):
    """Chat interactivo con el equipo orquestado (multi-agente)."""
    
    is_new_session = session is None
    session_id = session if session else generate_session_id(user)
    
    # Limpiar historial si se solicita
    if clear_history and session:
        if clear_session_history(user, session_id):
            console.print(f"[yellow]üóëÔ∏è Historial de sesi√≥n {session_id} limpiado[/yellow]")
        else:
            console.print(f"[red]‚ùå Error limpiando historial de sesi√≥n {session_id}[/red]")
    
    print_welcome_banner(session_id, user, is_new_session)

    try:
        team = build_team(user, session_id)
        logger.info(f"Team initialized for user '{user}' with session '{session_id}'")
        console.print(f"[green]‚úÖ[/green] Equipo inicializado con memoria contextual")
        
    except Exception as e:
        logger.error(f"Error initializing team: {e}", exc_info=True)
        console.print(Panel(
            f"[red]‚ùå Error al inicializar el equipo:[/red] {e}\n\n"
            f"üí° [bold]Posibles soluciones:[/bold]\n"
            f"‚Ä¢ Verifica que las variables de entorno est√©n configuradas\n"
            f"‚Ä¢ Aseg√∫rate de que las dependencias est√©n instaladas\n"
            f"‚Ä¢ Revisa los permisos de Google Cloud",
            title="Error de Inicializaci√≥n",
            border_style="red"
        ))
        raise typer.Exit(code=1)

    conversation_count = 0
    
    while True:
        try:
            prompt = f"[bold]üìù Consulta ({conversation_count + 1}) > [/bold] "
            query = console.input(prompt)
            
            # Comandos especiales
            if query.lower() in ["exit", "quit", "salir"]:
                console.print(f"[blue]üíæ Sesi√≥n guardada como: {session_id}[/blue]")
                logger.info(f"Session {session_id} ended after {conversation_count} conversations")
                break
                
            elif query.lower() in ["clear", "limpiar"]:
                conversation_count = 0
                console.print("[yellow]üîÑ Contexto reiniciado para esta sesi√≥n[/yellow]")
                continue
                
            elif query.lower() in ["new", "nuevo"]:
                new_session_id = generate_session_id(user)
                console.print(f"[green]üÜï Nueva sesi√≥n creada: {new_session_id}[/green]")
                console.print("[yellow]Reinicia el chat con: --session {new_session_id}[/yellow]")
                break
                
            elif not query.strip():
                console.print("[yellow]‚ö†Ô∏è La consulta no puede estar vac√≠a[/yellow]")
                continue

            # Procesar consulta
            with console.status(
                "[cyan]ü§ñ Orquestando agentes con contexto...[/cyan]", 
                spinner="dots"
            ):
                response = team.run(query)
                conversation_count += 1
                logger.info(f"Processed query #{conversation_count} for session {session_id}")

            # Mostrar respuesta
            response_content = getattr(response, "content", str(response))
            
            console.print(Panel(
                response_content,
                title=f"[bold magenta]üìä Respuesta del Equipo ({conversation_count})[/bold magenta]",
                border_style="magenta",
                padding=(1, 2)
            ))
            
            # Sugerencia despu√©s de varias consultas
            if conversation_count % 3 == 0:
                console.print(
                    "[dim]üí° Tip: Usa 'clear' para reiniciar el contexto o 'exit' para salir[/dim]"
                )
            
        except KeyboardInterrupt:
            console.print("\n[yellow]‚èπÔ∏è Interrupci√≥n recibida. Guardando contexto...[/yellow]")
            logger.info(f"Session {session_id} interrupted by user")
            break
            
        except Exception as e:
            logger.error(f"Error processing query: {e}", exc_info=True)
            console.print(Panel(
                f"[red]‚ùå Error al procesar consulta:[/red] {e}\n\n"
                f"üí° [bold]Sugerencias:[/bold]\n"
                f"‚Ä¢ Revisa tu conexi√≥n a internet\n"
                f"‚Ä¢ Verifica los permisos de Google Cloud\n"
                f"‚Ä¢ Intenta reformular tu pregunta",
                title="Error de Procesamiento",
                border_style="red"
            ))

@app.command()
def list_sessions(
    user: str = typer.Option("default_user", help="ID de usuario"),
    detailed: bool = typer.Option(False, help="Mostrar informaci√≥n detallada")
):
    """Lista las sesiones existentes para un usuario."""
    console.print(Panel(
        f"[bold]üìã Sesiones para usuario:[/bold] [cyan]{user}[/cyan]",
        border_style="blue"
    ))
    list_user_sessions(user, console, detailed)

@app.command()
def cleanup_sessions(
    user: str = typer.Option("default_user", help="ID de usuario"),
    older_than_days: int = typer.Option(30, help="Eliminar sesiones m√°s antiguas que X d√≠as")
):
    """Limpia sesiones antiguas para un usuario."""
    from src.storage.db_utils import cleanup_old_sessions
    
    console.print(Panel(
        f"[bold]üßπ Limpiando sesiones antiguas para:[/bold] [cyan]{user}[/cyan]\n"
        f"[bold]üìÖ M√°s antiguas que:[/bold] [yellow]{older_than_days}[/yellow] d√≠as",
        border_style="yellow"
    ))
    
    deleted_count = cleanup_old_sessions(user, older_than_days, console)
    
    if deleted_count > 0:
        console.print(f"[green]‚úÖ {deleted_count} sesiones eliminadas[/green]")
    else:
        console.print("[blue]üí° No se encontraron sesiones para eliminar[/blue]")

@app.command()
def test_connection():
    """Prueba la conexi√≥n con los servicios de Google Cloud."""
    from src.tools.vector_embedding import VertexSearchTool
    from src.config import settings
    
    console.print(Panel(
        "[bold]üîß Probando conexiones...[/bold]",
        border_style="blue"
    ))
    
    try:
        # Test configuraci√≥n
        console.print(f"[bold]‚öôÔ∏è Configuraci√≥n:[/bold]")
        console.print(f"  ‚Ä¢ Project ID: [cyan]{settings.google_project_id}[/cyan]")
        console.print(f"  ‚Ä¢ Data Store ID: [cyan]{settings.data_store_id}[/cyan]")
        console.print(f"  ‚Ä¢ DB Path: [cyan]{settings.db_file_path}[/cyan]")
        
        # Test Vector Search
        console.print(f"\n[bold]üîç Probando Vertex AI Search...[/bold]")
        tool = VertexSearchTool(
            project_id=settings.google_project_id,
            data_store_id=settings.data_store_id
        )
        
        test_query = "data engineering best practices"
        result = tool.search(test_query, page_size=1)
        
        if "error" in result.lower():
            console.print(f"[red]‚ùå Error en Vertex AI: {result}[/red]")
        else:
            console.print(f"[green]‚úÖ Vertex AI Search conectado correctamente[/green]")
            console.print(f"[dim]Muestra: {result[:100]}...[/dim]")
        
        console.print(f"\n[green]üéâ Todas las conexiones funcionan correctamente![/green]")
        
    except Exception as e:
        console.print(Panel(
            f"[red]‚ùå Error de conexi√≥n:[/red] {e}\n\n"
            f"üí° [bold]Verifica:[/bold]\n"
            f"‚Ä¢ Variables de entorno configuradas\n"
            f"‚Ä¢ Permisos de Google Cloud\n"
            f"‚Ä¢ Credenciales de autenticaci√≥n",
            title="Error de Conexi√≥n",
            border_style="red"
        ))
        raise typer.Exit(code=1)

@app.command()
def version():
    """Muestra la versi√≥n e informaci√≥n del sistema."""
    import agno
    import google.cloud.discoveryengine
    
    console.print(Panel(
        f"[bold]üì¶ Sistema Multi-Agente para Ingenier√≠a de Datos[/bold]\n\n"
        f"üî¢ [bold]Versi√≥n:[/bold] [cyan]1.0.0[/cyan]\n"
        f"üêç [bold]Python:[/bold] [yellow]{sys.version}[/yellow]\n"
        f"ü§ñ [bold]Agno:[/bold] [green]{agno.__version__}[/green]\n"
        f"‚òÅÔ∏è [bold]Google Cloud:[/bold] [blue]{google.cloud.discoveryengine.__version__}[/blue]\n\n"
        f"üìö [bold]Caracter√≠sticas:[/bold]\n"
        f"  ‚Ä¢ üéØ Orquestaci√≥n multi-agente\n"
        f"  ‚Ä¢ üìä RAG con Vertex AI Search\n"
        f"  ‚Ä¢ üåê B√∫squeda web en tiempo real\n"
        f"  ‚Ä¢ üíª Generaci√≥n de c√≥digo enterprise\n"
        f"  ‚Ä¢ üíæ Persistencia con SQLite",
        title="Informaci√≥n del Sistema",
        border_style="green"
    ))

def main():
    """Funci√≥n principal con manejo de errores global."""
    try:
        app()
    except KeyboardInterrupt:
        console.print("\n[yellow]üëã ¬°Hasta pronto![/yellow]")
    except Exception as e:
        logger.critical(f"Unhandled error in main: {e}", exc_info=True)
        console.print(Panel(
            f"[red]üí• Error cr√≠tico:[/red] {e}\n\n"
            f"üìù [bold]Por favor reporta este error:[/bold]\n"
            f"‚Ä¢ Session: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n"
            f"‚Ä¢ Error: {type(e).__name__}",
            title="Error Cr√≠tico",
            border_style="red"
        ))
        raise typer.Exit(code=1)

if __name__ == "__main__":
    main()